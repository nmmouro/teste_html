<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel TV - Frota</title>

  <!-- Anti-cache para GitHub Pages -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #000;
      color: #fff;
      overflow: hidden;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 30px;
      background: #111;
      border-bottom: 2px solid #222;
    }
    header img {
      height: 60px;
    }
    .titulo {
      text-align: center;
      flex: 1;
      font-size: 36px;
      font-weight: bold;
    }
    .relogio {
      text-align: right;
      font-size: 22px;
      min-width: 160px;
    }
    .container {
      display: grid;
      grid-template-rows: 1fr 1fr 1fr;
      height: calc(100vh - 90px);
      gap: 12px;
      padding: 12px;
    }
    .bloco {
      background: #111;
      border-radius: 12px;
      border: 2px solid #222;
      padding: 10px 14px;
      overflow: hidden;
    }
    .bloco h2 {
      margin: 0 0 6px;
      font-size: 22px;
      text-align: center;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 16px;
    }
    th, td {
      border-bottom: 1px solid #222;
      padding: 6px 8px;
      text-align: left;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    th {
      background: #1c1c1c;
      position: sticky;
      top: 0;
    }
    .status-andamento {
      background: #2a3b00;
      color: #fff600;
      font-weight: bold;
    }
    .status-concluido {
      background: #003015;
      color: #00ff90;
      font-weight: bold;
    }
  </style>
</head>
<body>

<header>
  <img src="logo.png" alt="Logo da empresa">
  <div class="titulo">PAINEL DE OPERAÇÕES</div>
  <div class="relogio" id="relogio"></div>
</header>

<div class="container">
  <div class="bloco">
    <h2>PAINEL</h2>
    <div id="painel"></div>
  </div>

  <div class="bloco">
    <h2>AGENDA DO DIA</h2>
    <div id="agendaDia"></div>
  </div>

  <div class="bloco">
    <h2>AGENDA SERVIÇO SOCIAL</h2>
    <div id="agendaSocial"></div>
  </div>
</div>

<script>
  /**************** CONFIG ********************/
  const SHEET_ID = "1Ch3AjQ0MDo4WuQWFDR3r8nZrHb4yQkSLOtT5_QgxT6E";

  const abas = {
    painel: "PAINEL",
    agendaDia: "AGENDA DO DIA",
    agendaSocial: "AGENDA SERVIÇO SOCIAL"
  };

  /************** RELÓGIO BR *******************/
  function atualizarRelogio() {
    const r = document.getElementById("relogio");
    const agora = new Date();
    const data = agora.toLocaleDateString("pt-BR");
    const hora = agora.toLocaleTimeString("pt-BR", {
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit"
    });
    r.innerHTML = data + "<br>" + hora;
  }
  setInterval(atualizarRelogio, 1000);
  atualizarRelogio();

  /************** URL **************************/
  function url(sheet) {
    return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheet)}&nocache=${Date.now()}`;
  }

  /************** HELPERS **********************/
  function escapeHtml(str){
    return String(str ?? "")
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;');
  }

  function formatCell(value) {
    if (value === null || value === undefined) return "";

    if (value instanceof Date && !isNaN(value)) {
      return value.toLocaleDateString('pt-BR');
    }

    if (typeof value === 'number') return String(value);

    if (typeof value === 'string') {
      const s = value.trim();

      // Date(YYYY,MM,DD[,HH,MM,SS])
      const dateMatch = s.match(/^Date\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)(?:\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+))?/);
      if (dateMatch) {
        const ano = Number(dateMatch[1]);
        const mes = Number(dateMatch[2]) + 1;
        const dia = Number(dateMatch[3]);

        if (dateMatch[4] !== undefined) {
          const hh = String(dateMatch[4]).padStart(2,'0');
          const mm = String(dateMatch[5] ?? 0).padStart(2,'0');
          const ss = String(dateMatch[6] ?? 0).padStart(2,'0');
          return `${String(dia).padStart(2,'0')}/${String(mes).padStart(2,'0')}/${ano} ${hh}:${mm}:${ss}`;
        }
        return `${String(dia).padStart(2,'0')}/${String(mes).padStart(2,'0')}/${ano}`;
      }

      // TimeOfDay(H,M,S)
      const timeMatch = s.match(/^TimeOfDay\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/);
      if (timeMatch) {
        const hh = String(timeMatch[1]).padStart(2,'0');
        const mm = String(timeMatch[2]).padStart(2,'0');
        const ss = String(timeMatch[3]).padStart(2,'0');
        return `${hh}:${mm}:${ss}`;
      }

      // ISO date: YYYY-MM-DD or datetime
      const isoDateMatch = s.match(/^(\d{4})-(\d{2})-(\d{2})(?:[T\s](\d{2}):(\d{2}):?(\d{2})?)?/);
      if (isoDateMatch) {
        const ano = isoDateMatch[1];
        const mes = isoDateMatch[2];
        const dia = isoDateMatch[3];
        if (isoDateMatch[4] !== undefined) {
          const hh = String(isoDateMatch[4]).padStart(2,'0');
          const mm = String(isoDateMatch[5] ?? '00').padStart(2,'0');
          const ss = String(isoDateMatch[6] ?? '00').padStart(2,'0');
          return `${dia}/${mes}/${ano} ${hh}:${mm}:${ss}`;
        }
        return `${dia}/${mes}/${ano}`;
      }

      return s;
    }

    if (typeof value === 'object') {
      if ('v' in value) return formatCell(value.v);
      if ('f' in value) return formatCell(value.f);
      try { return JSON.stringify(value); } catch(e) { return String(value); }
    }

    return String(value);
  }

  /************** CARREGAMENTO *****************/
  async function carregar(sheet, divId) {
    try {
      const res = await fetch(url(sheet), { cache: "reload" });
      const txt = await res.text();

      const json = JSON.parse(
        txt.substring(txt.indexOf("{"), txt.lastIndexOf("}") + 1)
      );

      const cols = json.table.cols.map(c => c.label);
      const rows = json.table.rows.map(r =>
        (r.c || []).map(c => (c ? c.v : ""))
      );

     renderTabela(divId, cols, rows, sheet);

    } catch (e) {
      document.getElementById(divId).innerHTML = "Erro ao carregar dados";
      console.error(sheet, e);
    }
  }

  /************** RENDER ***********************/
  function renderTabela(divId, cols, rows) {
    function renderTabela(divId, cols, rows, nomeAba) {
  const div = document.getElementById(divId);

  let html = "<table><thead><tr>";
  cols.forEach(c => html += `<th>${escapeHtml(c)}</th>`);
  html += "</tr></thead><tbody>";

  rows.forEach(r => {
    let classe = "";
    const statusBruto = r[r.length - 1] ?? "";
    const status = String(statusBruto).toLowerCase();

    if (status.includes("andamento")) classe = "status-andamento";
    if (status.includes("concluído") || status.includes("concluido"))
      classe = "status-concluido";

    html += `<tr class="${classe}">`;

    r.forEach((cellValue, idx) => {
      let valor = formatCell(cellValue);

      // ✅ REGRA ESPECIAL: somente na AGENDA DO DIA → coluna HORA
      if (
        nomeAba === "AGENDA DO DIA" &&
        cols[idx] &&
        cols[idx].toLowerCase().includes("hora")
      ) {
        // extrai somente HH:MM de qualquer formato
        const h = valor.match(/(\d{1,2}):(\d{2})/);
        if (h) {
          valor = `${h[1].padStart(2, "0")}:${h[2]}`;
        }
      }

      html += `<td>${escapeHtml(valor)}</td>`;
    });

    html += "</tr>";
  });

  html += "</tbody></table>";
  div.innerHTML = html;
}


  /************** AUTO REFRESH *****************/
  function atualizarTudo() {
    carregar(abas.painel, "painel");
    carregar(abas.agendaDia, "agendaDia");
    carregar(abas.agendaSocial, "agendaSocial");
  }

  atualizarTudo();
  setInterval(atualizarTudo, 60000); // 1 minuto

</script>

</body>
</html>
