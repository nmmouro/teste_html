<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Painel - Frota (GViz)</title>

<!-- evitar cache no GitHub Pages -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<style>
  :root{
    --bg:#071029; /*fundo*/
    --card:#2a71e8; /*cart√µes*/
    --muted:#f7f9fa; /*cabe√ßalhos*/
    --accent:#00eaff; /*t√≠tuos*/
    --danger:#9b1111;
    --cabe√ßanlho:#0037ff;
  }
  html,body{
    height:100%;
    margin:5px;
    background:var(--bg);
    color:#fff;
    font-family:Inter,Segoe UI,Arial,sans-serif;
  }
  header{
    display:flex;
    align-items:center;
    justify-content:space-around;
    padding:12px 20px;
    background:#455185;
    border-bottom:1px solid rgba(100,100,255,0.3);
    border-radius:10px;
  }
  header img{
    height:66px;
  }
  header .title{
    font-size:24px;
    font-weight:700;
    color:var(--accent);
  }
  header .clock{
    font-size:20px;
    color:var(--muted);
  }
  
  /*divis√£o das √°reas*/
  main{
    padding:12px;
    display:grid;
    grid-template-rows:1fr 1fr 1fr;
    gap:12px;
    height:calc(100vh - 92px);
    box-sizing:border-box;
  }
  
  /*espa√ßo das abas*/
  .card{
   background:var(--card);
  border-radius:10px;
  padding:12px;
  overflow:auto
}
  
  /*t√≠tulo da aba*/
  .card h2{
    margin:3 3 8px;
    color:var(--accent);
    font-size:22px;
    text-align:center;
  }
  
 table{
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;   /* üîí trava alinhamento */
    position: relative;
} 
  }
  
/* cabe√ßalho */
 thead th{
    position: sticky;
    top: 0;
    z-index: 3;
    background: #0435bf;
    color: #fff;
    font-weight: 700;
    padding: 8px;
    text-align: left;
}

     
/* c√©lulas */
th{
  width: 100%;
  text-align: left;
  font-weight: 700;
  font-size:18px;
   padding: 16px;
}

td{
  text-align: left;
   padding: 10px;
}



  tr.status-andamento{background: rgba(219,147,112,0.18)}
  tr.status-atendido{background: rgba(147,219,112,0.18)}
  tr.status-concluido{background: rgba(0,200,120,0.06)}
  
  @keyframes piscarCancelado {0%{opacity:1}50%{opacity:.3}100%{opacity:1}}
  tr.status-cancelado{background: rgba(155,17,17,0.18);
                      text-decoration:line-through;animation:piscarCancelado 3s infinite}
  
  /*rodap√©*/
  .small{
    font-size: 10px;
    color:var(--cabe√ßalho);
    text-align:center;
    margin-top:10px;
  }
  
  /* responsivo: se altura pequena, reduzir fonte */
  @media (max-height:700px){
    td,thead th{
      padding:6px;
      font-size:12px;
    }
  }

  /* Cabe√ßalho azul padr√£o
table thead th {
  background: #0435bf;
  color: white;
}
  */

</style>
</head>
<body>

<header>
  <img src="logo.png" alt="Logo (coloque logo.png na mesma pasta)" onerror="this.style.display='none'">
  <div class="title">MOVIMENTA√á√ÉO DI√ÅRIA</div>
  <div class="clock" id="clock">--:--</div>
</header>

<main>
  <section class="card" id="card-painel">
    <h2>PAINEL</h2>
    <div id="painel">Carregando...</div>
  </section>

  <section class="card" id="card-agenda">
    <h2>AGENDA DO DIA</h2>
    <div id="agenda">Carregando...</div>
  </section>

  <section class="card" id="card-ss">
    <h2>AGENDA SERVI√áO SOCIAL</h2>
    <div id="social">Carregando...</div>
  </section>
</main>

<div class="small">Atualiza√ß√£o autom√°tica a cada 60s ‚Ä¢ Fonte: Google Sheets (GViz)</div>

<script>
/* ============================
   CONFIG ‚Äî coloque seu Sheet ID
   ============================ */
const SHEET_ID = "1Ch3AjQ0MDo4WuQWFDR3r8nZrHb4yQkSLOtT5_QgxT6E";

/* nomes exatos das abas (case-sensitive) */
const TAB_PAINEL = "PAINEL";
const TAB_AGENDA = "AGENDA DO DIA";
const TAB_SS = "AGENDA SERVI√áO SOCIAL";

/* ============================
   REL√ìGIO (pt-BR)
   ============================ */
function updateClock(){
  const now = new Date();
  const optsDate = { day:"2-digit", month:"2-digit", year:"numeric" };
  const optsTime = { hour:"2-digit", minute:"2-digit"};
  document.getElementById("clock").textContent = now.toLocaleDateString("pt-BR",optsDate) + " ‚Äî " + now.toLocaleTimeString("pt-BR",optsTime);
}
setInterval(updateClock,1000);
updateClock();

/* ============================
   Helpers: escape + parse gviz robusto
   ============================ */
function escapeHtml(s){ return String(s ?? "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

function parseGvizText(text){
  // procura primeiro "{" e √∫ltimo "}" e parseia
  const first = text.indexOf("{");
  const last  = text.lastIndexOf("}");
  if (first === -1 || last === -1) throw new Error("Resposta inesperada do Google Sheets");
  const jsonText = text.substring(first, last+1);
  return JSON.parse(jsonText);
}

/* ============================
   Formata√ß√£o robusta de c√©lula
   - trata Date(yyyy,mm,dd[,HH,MM,SS])
   - trata TimeOfDay(H,M,S)
   - trata ISO YYYY-MM-DD[T ]HH:MM:SS
   - somenteHora flag: se true, retorna apenas HH:MM quando aplic√°vel
   ============================ */
function formatCell(raw, somenteHora=false){
  if (raw === null || raw === undefined) return "";

  // objetos com v/f
  if (typeof raw === "object"){
    if ("v" in raw) return formatCell(raw.v, somenteHora);
    if ("f" in raw) return formatCell(raw.f, somenteHora);
    try { return JSON.stringify(raw); } catch(e){ return String(raw); }
  }

  const s = String(raw).trim();

  // Date(YYYY,MM,DD[,HH,MM,SS])
  const dateMatch = s.match(/^Date\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)(?:\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d+)\s*)?)?\)/);
  if (dateMatch){
    const ano = Number(dateMatch[1]);
    const mes0 = Number(dateMatch[2]); // 0-based
    const dia = Number(dateMatch[3]);
    const hh = dateMatch[4] !== undefined ? Number(dateMatch[4]) : null;
    const mm = dateMatch[5] !== undefined ? Number(dateMatch[5]) : 0;

    // Se ano = 1899 (sheet time-only), retornar HH:MM
    if (ano === 1899){
      if (somenteHora) return `${String(hh ?? 0).padStart(2,"0")}:${String(mm).padStart(2,"0")}`;
      // se n√£o pedir somenteHora, ainda retornar s√≥ hora (evitar mostrar '30/12/1899')
      return `${String(hh ?? 0).padStart(2,"0")}:${String(mm).padStart(2,"0")}`;
    }

    // data real
    if (hh !== null && somenteHora){
      // se pediram somente hora e a data tem hora, retornar HH:MM
      return `${String(hh).padStart(2,"0")}:${String(mm).padStart(2,"0")}`;
    }
    const mes = String(mes0 + 1).padStart(2,"0");
    return `${String(dia).padStart(2,"0")}/${mes}/${ano}` + (hh !== null ? ` ${String(hh).padStart(2,"0")}:${String(mm).padStart(2,"0")}` : "");
  }

  // TimeOfDay(H,M,S)
  const timeMatch = s.match(/^TimeOfDay\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/);
  if (timeMatch){
    const hh = String(timeMatch[1]).padStart(2,"0");
    const mm = String(timeMatch[2]).padStart(2,"0");
    return somenteHora ? `${hh}:${mm}` : `${hh}:${mm}:${String(timeMatch[3]).padStart(2,"0")}`;
  }

  // ISO date/datetime YYYY-MM-DD[ T hh:mm:ss]
  const iso = s.match(/^(\d{4})-(\d{2})-(\d{2})(?:[T\s](\d{2}):(\d{2}):?(\d{2})?)?/);
  if (iso){
    const ano = iso[1], mes = iso[2], dia = iso[3];
    if (iso[4]){
      const hh = String(iso[4]).padStart(2,"0"), mm = String(iso[5] ?? "00").padStart(2,"0");
      return somenteHora ? `${hh}:${mm}` : `${dia}/${mes}/${ano} ${hh}:${mm}`;
    }
    return `${dia}/${mes}/${ano}`;
  }

  // fallback: texto puro
  return s;
}

/* ============================
   Render gen√©rico
   - aplica regra somenteHora para colunas cujo header inclua "hora"
   - regra v√°lida em PAINEL e AGENDA DO DIA (conforme sua solicita√ß√£o)
   - status styling (andamento, conclu√≠do, cancelado) para agendas e painel
   ============================ */
function renderTable(containerId, sheetName, gvizJson){
  const cols = (gvizJson.table.cols || []).map(c => c.label || "");
  const rows = (gvizJson.table.rows || []).map(r => (r.c || []).map(cell => (cell ? cell.v : "")));

  // build HTML table
  let html = "<table><thead><tr>";
  cols.forEach(h => html += `<th>${escapeHtml(h)}</th>`);
  html += "</tr></thead><tbody>";

  rows.forEach(row => {
    // status from last column (if exists)
    const rawStatus = String(row[row.length - 1] ?? "").toLowerCase();
    let classe = "";
    if (rawStatus.includes("andamento")) classe = "status-andamento";
    if (rawStatus.includes("atendido")) classe = "status-atendido";
    if (rawStatus.includes("conclu√≠do") || rawStatus.includes("concluido")) classe = "status-concluido";
    if (rawStatus.includes("cancelado")) classe = "status-cancelado";

    html += `<tr class="${classe}">`;

    row.forEach((cell, idx) => {
      // determine if this column is "Hora" and rule applies (PAINEL or AGENDA DO DIA)
      const header = cols[idx] || "";
      const isHoraColumn = /hora/i.test(header);
      const appliesHoraRule = isHoraColumn && (sheetName === TAB_PAINEL || sheetName === TAB_AGENDA);

      const formatted = formatCell(cell, appliesHoraRule);
      html += `<td>${escapeHtml(formatted)}</td>`;
    });

    html += "</tr>";
  });

  html += "</tbody></table>";
  document.getElementById(containerId).innerHTML = html;
}

/* ============================
   Fetch each sheet with nocache (robusto)
   ============================ */
async function fetchSheet(sheetName){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}&nocache=${Date.now()}`;
  const res = await fetch(url, { cache: "no-store", mode: "cors" });
  const text = await res.text();
  const parsed = parseGvizText(text);
  return parsed;
}

/* ============================
   Main loader
   ============================ */
async function loadAll(){
  try{
    const [gPainel, gAgenda, gSS] = await Promise.all([
      fetchSheet(TAB_PAINEL),
      fetchSheet(TAB_AGENDA),
      fetchSheet(TAB_SS)
    ]);

    renderTable("painel", TAB_PAINEL, gPainel);
    renderTable("agenda", TAB_AGENDA, gAgenda);
    renderTable("social", TAB_SS, gSS);
  } catch(err){
    console.error("Erro ao carregar sheets:", err);
    document.getElementById("painel").innerText = "Erro ao carregar dados";
    document.getElementById("agenda").innerText = "Erro ao carregar dados";
    document.getElementById("social").innerText = "Erro ao carregar dados";
  }
}

/* initial + interval */
loadAll();
setInterval(loadAll, 60000); // 60s
</script>
</body>
</html>
